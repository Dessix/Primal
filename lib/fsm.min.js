"use strict";var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},FSM;!function(t){function e(t,n){return!t.region||e(t.region.state,n)&&n.getCurrent(t.region)===t}function n(t,e){return t instanceof f?e.getCurrent(t).isFinal():t.regions.every(function(t){return n(t,e)})}function i(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var i=0,r=e;i<r.length;i++)for(var o=r[i],s=0,a=o;s<a.length;s++){var u=a[s];t.push(u)}}function r(t,e,n,i){void 0===i&&(i=!1);for(var r=0,o=t;r<o.length;r++){var s=o[r];s(e,n,i)}}function o(e,n,i){void 0===i&&(i=!0),n?(i&&e.clean===!1&&o(e),t.console.log("initialise "+n),r(e.onInitialise,void 0,n)):(t.console.log("initialise "+e.name),e.accept(new _,!1),e.clean=!0)}function s(e,n,i,r){return void 0===r&&(r=!0),r&&e.clean===!1&&o(e),t.console.log(n+" evaluate "+i),!n.isTerminated&&a(e,n,i)}function a(i,r,o){var s=!1;if(o!==i&&i.regions.every(function(t){return!a(r.getCurrent(t),r,o)||(s=!0,e(i,r))}),s)o!==i&&n(i,r)&&a(i,r,i);else{var c=i.outgoing.filter(function(t){return t.guard(o,r)});1===c.length?s=u(c[0],r,o):c.length>1&&t.console.error(i+": multiple outbound transitions evaluated true for message "+o)}return s}function u(t,e,o){var s=t,h=s.target,l=new Array;for(i(l,s.onTraverse);h&&h instanceof y&&h.kind===v.Junction;)s=c(h,e,o),h=s.target,i(l,s.onTraverse);return r(l,o,e),h&&(h instanceof y&&h.kind===v.Choice?u(c(h,e,o),e,o):h instanceof m&&n(h,e)&&a(h,e,h)),!0}function c(e,n,i){var r=e.outgoing.filter(function(t){return t.guard(i,n)});return e.kind===v.Choice?0!==r.length?r[t.random(r.length)]:h(e):r.length>1?void t.console.error("Multiple outbound transition guards returned true at "+e+" for "+i):r[0]||h(e)}function h(t){return t.outgoing.filter(function(t){return t.guard===E.FalseGuard})[0]}function l(t){t.accept(new I)}!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory",t[t.Terminate=5]="Terminate"}(t.PseudoStateKind||(t.PseudoStateKind={}));var v=t.PseudoStateKind;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(t.TransitionKind||(t.TransitionKind={}));var g=t.TransitionKind,p=function(){function t(e,n){this.name=e,this.qualifiedName=n?n.qualifiedName+t.namespaceSeparator+e:e}return t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}();t.Element=p;var f=function(e){function n(t,n){e.call(this,t,n),this.vertices=new Array,this.state=n,this.state.regions.push(this),this.state.getRoot().clean=!1}return __extends(n,e),n.prototype.remove=function(){for(var e=0,n=this.vertices;e<n.length;e++){var i=n[e];i.remove()}this.state.regions.splice(this.state.regions.indexOf(this),1),t.console.log("remove "+this),this.state.getRoot().clean=!1},n.prototype.getRoot=function(){return this.state.getRoot()},n.prototype.accept=function(t,e,n,i){return t.visitRegion(this,e,n,i)},n.defaultName="default",n}(p);t.Region=f;var d=function(e){function n(t,n){e.call(this,t,m.parent(n)),this.outgoing=new Array,this.incoming=new Array,this.region=m.parent(n),this.region&&(this.region.vertices.push(this),this.region.getRoot().clean=!1)}return __extends(n,e),n.parent=function(t){return t instanceof m?t.defaultRegion():t},n.prototype.ancestry=function(){return(this.region?this.region.state.ancestry():new Array).concat(this)},n.prototype.getRoot=function(){return this.region.getRoot()},n.prototype.remove=function(){for(var e=0,n=this.outgoing;e<n.length;e++){var i=n[e];i.remove()}for(var r=0,o=this.incoming;r<o.length;r++){var i=o[r];i.remove()}this.region.vertices.splice(this.region.vertices.indexOf(this),1),t.console.log("remove "+this),this.region.getRoot().clean=!1},n.prototype.to=function(t,e){return void 0===e&&(e=g.External),new E(this,t,e)},n}(p);t.Vertex=d;var y=function(t){function e(e,n,i){void 0===i&&(i=v.Initial),t.call(this,e,n),this.kind=i}return __extends(e,t),e.prototype.isHistory=function(){return this.kind===v.DeepHistory||this.kind===v.ShallowHistory},e.prototype.isInitial=function(){return this.kind===v.Initial||this.isHistory()},e.prototype.accept=function(t,e,n,i){return t.visitPseudoState(this,e,n,i)},e}(d);t.PseudoState=y;var m=function(t){function e(e,n){t.call(this,e,n),this.exitBehavior=new Array,this.entryBehavior=new Array,this.regions=new Array}return __extends(e,t),e.prototype.defaultRegion=function(){return this.regions.reduce(function(t,e){return e.name===f.defaultName?e:t},void 0)||new f(f.defaultName,this)},e.prototype.isFinal=function(){return 0===this.outgoing.length},e.prototype.isSimple=function(){return 0===this.regions.length},e.prototype.isComposite=function(){return this.regions.length>0},e.prototype.isOrthogonal=function(){return this.regions.length>1},e.prototype.remove=function(){for(var e=0,n=this.regions;e<n.length;e++){var i=n[e];i.remove()}t.prototype.remove.call(this)},e.prototype.exit=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.entry=function(t){return this.entryBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.accept=function(t,e,n,i){return t.visitState(this,e,n,i)},e}(d);t.State=m;var S=function(t){function e(e,n){t.call(this,e,n)}return __extends(e,t),e.prototype.accept=function(t,e,n,i){return t.visitFinalState(this,e,n,i)},e}(m);t.FinalState=S;var b=function(t){function e(e){t.call(this,e,void 0),this.clean=!1}return __extends(e,t),e.prototype.getRoot=function(){return this.region?this.region.getRoot():this},e.prototype.accept=function(t,e,n,i){return t.visitStateMachine(this,e,n,i)},e}(m);t.StateMachine=b;var E=function(){function e(t,n,i){var r=this;void 0===i&&(i=g.External),this.transitionBehavior=new Array,this.source=t,this.target=n,this.kind=n?i:g.Internal,this.guard=t instanceof y?e.TrueGuard:function(t){return t===r.source},this.source.outgoing.push(this),this.target&&this.target.incoming.push(this),this.source.getRoot().clean=!1}return e.prototype.else=function(){return this.guard=e.FalseGuard,this},e.prototype.when=function(t){return this.guard=t,this},e.prototype.effect=function(t){return this.transitionBehavior.push(t),this.source.getRoot().clean=!1,this},e.prototype.remove=function(){this.source.outgoing.splice(this.source.outgoing.indexOf(this),1),this.target&&this.target.incoming.splice(this.target.incoming.indexOf(this),1),t.console.log("remove "+this),this.source.getRoot().clean=!1},e.prototype.accept=function(t,e,n,i){return t.visitTransition(this,e,n,i)},e.prototype.toString=function(){return"[ "+(this.target?this.source+" -> "+this.target:this.source)+"]"},e.TrueGuard=function(){return!0},e.FalseGuard=function(){return!1},e}();t.Transition=E;var T=function(){function t(t){void 0===t&&(t="unnamed"),this.last=[],this.isTerminated=!1,this.name=t}return t.prototype.setCurrent=function(t,e){this.last[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.last[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}();t.StateMachineInstance=T;var x=function(){function t(){}return t.prototype.visitElement=function(t,e,n,i){},t.prototype.visitRegion=function(t,e,n,i){for(var r=this.visitElement(t,e,n,i),o=0,s=t.vertices;o<s.length;o++){var a=s[o];a.accept(this,e,n,i)}return r},t.prototype.visitVertex=function(t,e,n,i){for(var r=this.visitElement(t,e,n,i),o=0,s=t.outgoing;o<s.length;o++){var a=s[o];a.accept(this,e,n,i)}return r},t.prototype.visitPseudoState=function(t,e,n,i){return this.visitVertex(t,e,n,i)},t.prototype.visitState=function(t,e,n,i){for(var r=this.visitVertex(t,e,n,i),o=0,s=t.regions;o<s.length;o++){var a=s[o];a.accept(this,e,n,i)}return r},t.prototype.visitFinalState=function(t,e,n,i){return this.visitState(t,e,n,i)},t.prototype.visitStateMachine=function(t,e,n,i){return this.visitState(t,e,n,i)},t.prototype.visitTransition=function(t,e,n,i){},t}();t.Visitor=x,t.isActive=e,t.isComplete=n;var w=function(t){return Math.floor(Math.random()*t)};t.random=w,t.initialise=o,t.evaluate=s;var k=function(){function t(){this.leave=new Array,this.beginEnter=new Array,this.endEnter=new Array}return t.prototype.enter=function(){var t=new Array;return i(t,this.beginEnter,this.endEnter),t},t}(),R=function(o){function s(){o.apply(this,arguments)}return __extends(s,o),s.prototype.visitTransition=function(t,e){switch(t.onTraverse=new Array,t.kind){case g.Internal:this.visitInternalTransition(t,e);break;case g.Local:this.visitLocalTransition(t,e);break;case g.External:this.visitExternalTransition(t,e)}},s.prototype.visitInternalTransition=function(e,r){i(e.onTraverse,e.transitionBehavior),t.internalTransitionsTriggerCompletion&&e.onTraverse.push(function(t,i){var r=e.source;n(r,i)&&a(r,i,r)})},s.prototype.visitLocalTransition=function(t,n){var i=this;t.onTraverse.push(function(o,s){for(var a=t.target.ancestry(),u=0;e(a[u],s);)++u;for(r(n(s.getCurrent(a[u].region)).leave,o,s),r(t.transitionBehavior,o,s);u<a.length;)i.cascadeElementEntry(t,n,a[u++],a[u],function(t){return r(t,o,s)});r(n(t.target).endEnter,o,s)})},s.prototype.visitExternalTransition=function(t,e){for(var n=t.source.ancestry(),r=t.target.ancestry(),o=Math.min(n.length,r.length)-1;n[o-1]!==r[o-1];)--o;for(i(t.onTraverse,e(n[o]).leave,t.transitionBehavior);o<r.length;)this.cascadeElementEntry(t,e,r[o++],r[o],function(e){return i(t.onTraverse,e)});i(t.onTraverse,e(t.target).endEnter)},s.prototype.cascadeElementEntry=function(t,e,n,i,r){if(r(e(n).beginEnter),i&&n instanceof m)for(var o=0,s=n.regions;o<s.length;o++){var a=s[o];r(e(a).beginEnter),a!==i.region&&r(e(a).endEnter)}},s}(x),_=function(e){function n(){e.apply(this,arguments),this.behaviors={}}return __extends(n,e),n.prototype.behavior=function(t){return this.behaviors[t.qualifiedName]||(this.behaviors[t.qualifiedName]=new k)},n.prototype.visitElement=function(e,n){t.console!==C&&(this.behavior(e).leave.push(function(n,i){return t.console.log(i+" enter "+e)}),this.behavior(e).beginEnter.push(function(n,i){return t.console.log(i+" enter "+e)}))},n.prototype.visitRegion=function(t,e){for(var n=this,o=t.vertices.reduce(function(t,e){return e instanceof y&&e.isInitial()?e:t},void 0),s=0,a=t.vertices;s<a.length;s++){var u=a[s];u.accept(this,e||o&&o.kind===v.DeepHistory)}this.behavior(t).leave.push(function(e,i){return r(n.behavior(i.getCurrent(t)).leave,e,i)}),e||!o||o.isHistory()?this.behavior(t).endEnter.push(function(e,i,s){return r(n.behavior(s||o.isHistory()?i.getCurrent(t)||o:o).enter(),e,i,s||o.kind===v.DeepHistory)}):i(this.behavior(t).endEnter,this.behavior(o).enter()),this.visitElement(t,e)},n.prototype.visitPseudoState=function(t,n){var i=this;e.prototype.visitPseudoState.call(this,t,n),t.isInitial()?this.behavior(t).endEnter.push(function(e,n,o){n.getCurrent(t.region)?(r(i.behavior(t).leave,e,n),r(i.behavior(n.getCurrent(t.region)).enter(),e,n,o||t.kind===v.DeepHistory)):u(t.outgoing[0],n)}):t.kind===v.Terminate&&this.behavior(t).beginEnter.push(function(t,e){return e.isTerminated=!0})},n.prototype.visitState=function(t,e){for(var n=0,r=t.regions;n<r.length;n++){var o=r[n];o.accept(this,e),i(this.behavior(t).leave,this.behavior(o).leave),i(this.behavior(t).endEnter,this.behavior(o).enter())}this.visitVertex(t,e),i(this.behavior(t).leave,t.exitBehavior),i(this.behavior(t).beginEnter,t.entryBehavior),this.behavior(t).beginEnter.push(function(e,n){t.region&&n.setCurrent(t.region,t)})},n.prototype.visitStateMachine=function(t,n){var i=this;e.prototype.visitStateMachine.call(this,t,n),t.accept(new R,function(t){return i.behavior(t)}),t.onInitialise=this.behavior(t).enter()},n}(x),C={log:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},warn:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},error:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];throw t}};t.console=C,t.internalTransitionsTriggerCompletion=!1,t.validate=l;var I=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.visitPseudoState=function(n){e.prototype.visitPseudoState.call(this,n),n.kind===v.Choice||n.kind===v.Junction?(0===n.outgoing.length&&t.console.error(n+": "+n.kind+" pseudo states must have at least one outgoing transition."),n.outgoing.filter(function(t){return t.guard===E.FalseGuard}).length>1&&t.console.error(n+": "+n.kind+" pseudo states cannot have more than one Else transitions.")):(0!==n.outgoing.filter(function(t){return t.guard===E.FalseGuard}).length&&t.console.error(n+": "+n.kind+" pseudo states cannot have Else transitions."),n.isInitial()&&(n.outgoing.length>1?t.console.error(n+": initial pseudo states must have no more than one outgoing transition."):1===n.outgoing.length&&n.outgoing[0].guard!==E.TrueGuard&&t.console.error(n+": initial pseudo states cannot have a guard condition.")))},n.prototype.visitRegion=function(n){e.prototype.visitRegion.call(this,n);for(var i=0,r=0,o=0,s=0,a=n.vertices;s<a.length;s++){var u=a[s];u instanceof y&&(u.kind===v.Initial?i++:u.kind===v.DeepHistory?r++:u.kind===v.ShallowHistory&&o++)}i>1&&t.console.error(n+": regions may have at most one initial pseudo state."),r>1&&t.console.error(n+": regions may have at most one deep history pseudo state."),o>1&&t.console.error(n+": regions may have at most one shallow history pseudo state.")},n.prototype.visitState=function(n){e.prototype.visitState.call(this,n),n.regions.filter(function(t){return t.name===f.defaultName}).length>1&&t.console.error(n+": a state cannot have more than one region named "+f.defaultName)},n.prototype.visitFinalState=function(n){e.prototype.visitFinalState.call(this,n),0!==n.outgoing.length&&t.console.error(n+": final states must not have outgoing transitions."),0!==n.regions.length&&t.console.error(n+": final states must not have child regions."),n.entryBehavior.length>0&&t.console.warn(n+": final states may not have entry behavior."),n.exitBehavior.length>0&&t.console.warn(n+": final states may not have exit behavior.")},n.prototype.visitTransition=function(n){e.prototype.visitTransition.call(this,n),n.kind===g.Local&&n.target.ancestry().indexOf(n.source)===-1&&t.console.error(n+": local transition target vertices must be a child of the source composite sate.")},n}(x)}(FSM=exports.FSM||(exports.FSM={}));